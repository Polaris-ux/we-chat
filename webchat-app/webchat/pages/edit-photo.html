<!doctype html>
<html>

	<head>
		<meta charset="utf-8">
		<title></title>
		<meta name="viewport"
			content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="../css/mui.css" rel="stylesheet" />
		<link href="../css/index/header.css" rel="stylesheet" />
		<script src="../js/mui.js"></script>
		<script src="../js/app.js"></script>
		<style type="text/css">
			.title a{
				text-align: center;
			}
		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav title">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left title-color"></a>
			<!-- 操作表的点击按钮 -->
			<a class="mui-icon mui-media-object  mui-pull-right title-color" id="action-choose"
				style="width: 44px;">...</a>
			<h1 class="mui-title title-color">语 春 风</h1>
		</header>
		<div class="mui-content">
			<img src="../images/avtor.jpg" alt="加载中" id="my_faceImage">
		</div>
		<div id="behavior-choose" class="mui-popover mui-popover-bottom mui-popover-action ">
			<!-- 可选择菜单 -->
			<ul class="mui-table-view">
			  <li class="mui-table-view-cell">
				<a href="#" style="color: orange;" id="link-edit-images">修改头像</a>
			  </li>
			  <li class="mui-table-view-cell">
				<a href="#" style="color: orange;" id="link-save-image">保存头像</a>
			  </li>
			</ul>
			<!-- 取消菜单 -->
			<ul class="mui-table-view">
			  <li class="mui-table-view-cell">
				<a href="#behavior-choose" style="color: orange;"><b>取消</b></a>
			  </li>
			</ul>
		</div>

		<script type="text/javascript">
			mui.init();
			mui.plusReady(function () {
				// 获取用户信息
				var userInfo=app.getUserInfo();
				var my_image=document.getElementById("my_faceImage");
				
				if(app.isNotNUll(userInfo)){
					if(app.isNotNUll(userInfo.faceImage)){
						my_image.src=app.imageServerUrl+userInfo.faceImage;
						console.log(my_image.src);
					}
				}
				// 设置图片高度和宽度
				var width=document.body.clientWidth;
				my_image.width=width;
				my_image.height=width;
				
			   // 为操作表绑定事件
			   document.getElementById("action-choose").addEventListener("tap",function(){
				   mui("#behavior-choose").popover("toggle");
			   });
			   
			   // 个人头像选择
			   document.getElementById("link-edit-images").addEventListener("tap",function(){
				  mui.openWindow({
					  url:"../plugin/v3.1.6/myface-uploader.html",
					  id:'myface-uploader'
				  }); 
				  // 将操作表隐藏起来
				  mui("#behavior-choose").popover("toggle");
			   });
			   
			   // TODO:保存头像
			   document.getElementById("link-save-image").addEventListener("tap",function(){
				   plus.nativeUI.showWaiting("下载中...");
				   
				   // 获取用户全局信息
				   var userInfo=app.getUserInfo();
				   var faceImage=userInfo.faceImageBig;
				   console.log(faceImage);
				   var task=plus.downloader.createDownload(app.imageServerUrl+faceImage,{},function(downloadFile,status){
					   plus.nativeUI.closeWaiting();
					   if(status==200){
						   var tempFile=downloadFile.filename;
						   // 通过相册api保存照片到本地
						   plus.gallery.save(tempFile,function(){
							   app.showToAst("保存图片成功","success");
						   });
					   }else{
						   app.showToAst("下载错误","error");
					   }
				   });
				   
				   // 启动下载任务
				   task.start();
				   
			   });
			   
				
			});
		</script>
	</body>

</html>
